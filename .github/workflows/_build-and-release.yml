name: Build Binaries and Attach to Release

# Reusable workflow for building and releasing binaries
# Can be called from any release workflow (semver, dev, hotfix, manual)
on:
  workflow_call:
    inputs:
      release_tag:
        description: 'Release tag to attach binaries to (e.g., v5.0.1)'
        required: true
        type: string
      is_prerelease:
        description: 'Whether this is a prerelease (dev build)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # Required to upload release assets

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: ha-mcp-linux
            binary_ext: ''
            platform: linux
          - os: windows-latest
            artifact_name: ha-mcp-windows
            binary_ext: '.exe'
            platform: win32
          - os: macos-latest
            artifact_name: ha-mcp-macos-arm64
            binary_ext: ''
            platform: darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Create virtual environment and install dependencies
        run: |
          uv venv .venv
          uv pip install -e . pyinstaller
        shell: bash

      - name: Activate venv (Unix)
        if: runner.os != 'Windows'
        run: echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: Activate venv (Windows)
        if: runner.os == 'Windows'
        run: echo "$PWD/.venv/Scripts" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Build binary
        run: pyinstaller packaging/binary/ha-mcp.spec

      - name: Test binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          chmod +x dist/ha-mcp
          dist/ha-mcp --smoke-test

      - name: Test binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & "dist\ha-mcp.exe" --smoke-test
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Smoke test failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      - name: Rename binary for artifact
        shell: bash
        run: |
          mv dist/ha-mcp${{ matrix.binary_ext }} dist/${{ matrix.artifact_name }}${{ matrix.binary_ext }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.artifact_name }}${{ matrix.binary_ext }}
          if-no-files-found: error

  create-mcpb:
    name: Create MCPB Bundle
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Download Windows binary
        uses: actions/download-artifact@v7
        with:
          name: ha-mcp-windows
          path: mcpb-bundle

      - name: Download macOS binary
        uses: actions/download-artifact@v7
        with:
          name: ha-mcp-macos-arm64
          path: mcpb-bundle

      - name: Create MCPB bundle
        run: |
          VERSION="${{ inputs.release_tag }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix

          # Rename binaries to standard names
          mv mcpb-bundle/ha-mcp-windows.exe mcpb-bundle/ha-mcp.exe
          mv mcpb-bundle/ha-mcp-macos-arm64 mcpb-bundle/ha-mcp

          # Copy icons to bundle
          cp packaging/mcpb/icon-*.png mcpb-bundle/
          cp packaging/mcpb/icon-512.png mcpb-bundle/icon.png

          # Generate manifest.json
          python packaging/mcpb/generate_manifest.py "$VERSION"

          # Create .mcpb file (zip archive)
          cd mcpb-bundle
          zip -r ../ha-mcp.mcpb *
          cd ..

          echo "=== MCPB Contents ==="
          unzip -l ha-mcp.mcpb

      - name: Upload MCPB artifact
        uses: actions/upload-artifact@v6
        with:
          name: ha-mcp-mcpb
          path: ha-mcp.mcpb
          if-no-files-found: error

  upload-to-release:
    name: Upload Binaries to Release
    needs: [build, create-mcpb]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ha-mcp-*
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts/

      - name: Upload binaries to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.release_tag }}"

          echo "Uploading binaries to release $TAG..."

          # Check if release exists and is draft
          RELEASE_INFO=$(gh api repos/${{ github.repository }}/releases/tags/$TAG 2>/dev/null || echo "")

          if [ -z "$RELEASE_INFO" ]; then
            echo "Error: Release $TAG not found"
            exit 1
          fi

          IS_DRAFT=$(echo "$RELEASE_INFO" | jq -r '.draft')
          echo "Release $TAG draft status before upload: $IS_DRAFT"

          # Upload all binaries
          gh release upload "$TAG" \
            artifacts/ha-mcp-linux/ha-mcp-linux \
            artifacts/ha-mcp-windows/ha-mcp-windows.exe \
            artifacts/ha-mcp-macos-arm64/ha-mcp-macos-arm64 \
            artifacts/ha-mcp-mcpb/ha-mcp.mcpb \
            --clobber

          echo "✓ Uploaded binaries to $TAG"

          # Re-check draft status after upload (in case it changed)
          RELEASE_INFO_AFTER=$(gh api repos/${{ github.repository }}/releases/tags/$TAG 2>/dev/null || echo "")
          IS_DRAFT_AFTER=$(echo "$RELEASE_INFO_AFTER" | jq -r '.draft')
          echo "Release $TAG draft status after upload: $IS_DRAFT_AFTER"

          # If release is still draft, publish it
          if [ "$IS_DRAFT_AFTER" = "true" ]; then
            echo "Publishing draft release..."
            gh release edit "$TAG" --draft=false
            echo "✓ Published release $TAG"
          else
            echo "Release is already published, skipping publish step"
          fi
